/* Main.c file generated by New Project wizard
 *
 * Created:   Вт окт 15 2019
 * Processor: 80C51
 * Compiler:  Keil for 8051
 */

#include<reg51.h>
//объявления всех используемых функций
void delay(unsigned int time);
void lcdcmd(unsigned char value);
void lcddata(unsigned char value); 
void tochar(unsigned int value); 		//перевод integer в char для отображения на LCD
int keypad(); 					//функция для считывания нажатия клавиш
void setAlarm();					//функция установки будильника
void signal1();					//функция генерирующая звуковой сигнал 1
void signal2();					//функция генерирующая звуковой сигнал 2
int chkKey();					// вспомогательная функция для установки времени
void chkConditions(); 				//проверка условий переполнения и подачи сигнала
void clockdelay();				//Функция отсчитывающая секунды, минуты, часы
void start();					//функция вывода времени после переустановки
void setTime();					//функция установки времени
void lcdint(void); 


//Порт P0
sbit buzzer=P0^0;				//пин отвечающий за динамик

//Порт P3
sbit rs=P3^5;   					//Register select (RS)
sbit en=P3^6;   					//Enable (EN) pin
sbit rw=P3^7;					// Read/write pin

//Порт P1
//строки матрицы 4х4
sbit r0=P1^3;   
sbit r1=P1^2; 
sbit r2=P1^1; 
sbit r3=P1^0;
// столбцы матрицы 4х4
sbit c0=P1^4; 
sbit c1=P1^5; 
sbit c2=P1^6; 
 

//Текстовые подсказки, выводимые на LCD
char clock[]={"Alarm *"},hour[]="HOURS-> 01 - 12",mint[]="MINTS-> 01 - 60", hint[]={"RESet #"};
char alarm[]=" DIGITAL ALARM";


//Счётчик+ переменные для храниния числа часов минут секунд+ массивы для введённых значений 
int count=0,H,M,S,hour1[2],mint1[2]; 	//переменные для установки часов
int H1,M1,hour2[2],mint2[2]; 		//переменные для установки будтльника
int flag=0;						//флаг установки будильника


/***************************************************************************************************************/
//Вариант функции для создания задержки на заданное количество  микро -секунд
void delay(unsigned int time)  
{
      unsigned int i,j;
      for(i=0;i<time;i++);
	//for(j=0;j<5;j++);
}

/***************************************************************************************************************/
//Функция отправки команд на контроллер LCD (HD44780)
void lcdcmd(unsigned char value)  
{
	 P2=value;      	//Второй порт отправляет значения к регистру команд/данных LCD
	 //P3=0x40;     	// 0100 0000 -P3.6(16 pin)- установка бита en в единицу
	 rw=0; 
	 rs=0; 
	 en=0;
	 delay(300); 
	 en=1; 
	 delay(300); 
	 en=0;
	 return;
}

/***************************************************************************************************************/
// Функция отправки и вывода данных  на LCD
void lcddata(unsigned char value)  
{
	 P2=value;                     
	 //P3=0x60; 	// 0110 0000 установка en и rs(1-данныеб 0 -команды) в единицу Либо: rs=1;en=1;
	 rw=0; 
	 rs=1; 
	 en=0; 
	 delay(300); 
	 en=1; 
	 delay(300); 
	 en=0;
	 return;
}


/***************************************************************************************************************/
// Функция перевода integer в char и вывода на LCD
void tochar(unsigned int value)
{
	char tendigit,unitdigit;
	tendigit=value/10; 	// количество десятков в числе
	lcddata(tendigit+48); 	// перевод цифры десятков в символ
	unitdigit=value%10; 	// количество единиц в числе
	lcddata(unitdigit+48); 	// перевод цифры единицы в символ
}


/***************************************************************************************************************/
// функция считывания ввода
int keypad()
{
	unsigned int c;
	c=42;	// инициализируем произвольным значением
	while(1)
	{
	 //низкий уровень на первой строке
	 r0=0;r1=1;r2=1;r3=1;
	if(c0==0 && r0==0 )
		{lcddata('1');delay(100000);P1=0xFF;return c=1;}
    	if(c1==0 && r0==0)
		{ lcddata('2');delay(100000);P1=0xFF;return c=2;}
	if(c2==0 && r0==0)
		{ lcddata('3');delay(100000);P1=0xFF;return c=3;}
	
		
	//низкий уровень на второй строке
	r0=1;r1=0;r2=1;r3=1;
	if(c0==0 && r1==0)
		{ lcddata('4');delay(100000);P1=0xFF;return c=4;}
    	if(c1==0 && r1==0)
		{ lcddata('5');delay(100000);P1=0xFF;return c=5;}
	if(c2==0 && r1==0)
		{ lcddata('6');delay(100000);P1=0xFF;return c=6;}

		
	//низкий уровень на 3-й строке
	r0=1;r1=1;r2=0;r3=1;
	if(c0==0 && r2==0)
		{ lcddata('7');delay(100000);P1=0xFF;return c=7;}
    	if(c1==0 && r2==0)
		{ lcddata('8');delay(100000);P1=0xFF;return c=8;}
	if(c2==0 && r2==0)
		{ lcddata('9');delay(100000);P1=0xFF;return c=9;}
		
	//низкий уровень на 4-й строке
	r0=1;r1=1;r2=1;r3=0;
	if(c1==0 && r3==0)
		{ lcddata('0');delay(100000);P1=0xFF;return c=0;}
				
      }

}


/***************************************************************************************************************/
// Функция установки будильника
void setAlarm()
{
   count=0;
   lcdcmd(0x01); 
   lcdcmd(0x80);
   while(hour[count]!='\0')		//вывод подсказки выставления часов
      {
	 lcddata(hour[count]);
	 count++;
      }
   count=0; 
   lcdcmd(0xC8);
   while(count!=2)
      {
	 hour2[count]=keypad();	//считывание часа
	 count++;
      }
   H1=(hour2[0]*10)+hour2[1];	//сохранение часа будильника
   count=0; 
   lcdcmd(0x01); 
   lcdcmd(0x80);
   while(mint[count]!='\0')		//вывод подсказки выставления минут
      {
	  lcddata(mint[count]);
	  count++;
	 }
   count=0; 
   lcdcmd(0xC8);
   while(count!=2)
      {
	  mint2[count]=keypad();	//считывание минут
	  count++;
	}
   M1=(mint2[0]*10)+mint2[1];	//сохранение минут будильника
   count=0; 
   delay(1000); 
   lcdcmd(0x01); 
   lcdcmd(0x80); 
   count=0;
   while(alarm[count]!='\0')		//вывод подсказки о буддильнике
   {
	lcddata(alarm[count]);
	count++;
     }
   count=0;
   lcdcmd(0xC4);
   tochar(H);
   lcddata(':');
   tochar(M);
   lcdcmd(0xCB);
   tochar(S);
   flag=1;  					//завершение установки будильника					  
}




/***************************************************************************************************************/
//Вспомогательная функция для настройки часов
int chkKey(){ 
      r0=1;r1=1;r2=1;r3=0;
      if(c0==0) { return 2; }	//нажата клавиша *
      if(c2==0) { return 1; } 	//нажата клавиши #
      return 0;
}


/***************************************************************************************************************/
// Функция для подачи звукового сигнала частоты 1кГц длительность 1с
void signal1(){
   int count;
   lcdcmd(0xCB);
   tochar(S);
    count=0;
	    while(count!=990)
	    {
	       TMOD=0x01;  	//16-битный режим для таймера 0
	       TH0=0xFE;   	// Загружаем старший байт в регистрTH
	       TL0=0x0C;   	// Загружаем младший байт в регистр TL
	       TR0=1;      	// Запускаем таймер
	       buzzer=0;		// подать звуковой сигнал
	       while(!TF0);   	// пока таймер не переполнен выполняем пустой цикл
	       TR0 = 0;      	// При переполнении останавливаем таймер
	       TF0 = 0;      	// очищаем флаг переполнения для следующего цикла
	       buzzer=1;		// звуковой сигнал откл
	       
	       TMOD=0x01;  	//16-битный режим для таймера 0
	       TH0=0xFE;   	// Загружаем старший байт в регистрTH
	       TL0=0x0C;   	// Загружаем младший байт в регистр TL
	       TR0=1;      	// Запускаем таймер
	       while(!TF0);   	// пока таймер не переполнен выполняем пустой цикл
	       TR0 = 0;      	// При переполнении останавливаем таймер
	       TF0 = 0;      	// очищаем флаг переполнения для следующего цикла
	       count++;
	       }
        S++;
	lcdcmd(0xCB);
	tochar(S);
	count=0;
	while(count!=490)
	    {
	       TMOD=0x01;  	//16-битный режим для таймера 0
	       TH0=0xFC;   	// Загружаем старший байт в регистрTH
	       TL0=0x18;   	// Загружаем младший байт в регистр TL
	       TR0=1;      	// Запускаем таймер
	       while(!TF0);   	// пока таймер не переполнен выполняем пустой цикл
	       TR0 = 0;      	// При переполнении останавливаем таймер
	       TF0 = 0;      	// очищаем флаг переполнения для следующего цикла
	       count++;
	       }
   }


/***************************************************************************************************************/
// Функция для подачи звукового сигнала частоты 2кГц длительность 0.5с
void signal2(){
   int count;
    count=0;
    while(count!=990)
	    {
	       TMOD=0x01;  	//16-битный режим для таймера 0
	       TH0=0xFF;   	// Загружаем старший байт в регистрTH
	       TL0=0x06;   	// Загружаем младший байт в регистр TL
	       TR0=1;      	// Запускаем таймер
	       buzzer=0;		// подать звуковой сигнал
	       while(!TF0);   	// пока таймер не переполнен выполняем пустой цикл
	       TR0 = 0;      	// При переполнении останавливаем таймер
	       TF0 = 0;      	// очищаем флаг переполнения для следующего цикла
	       buzzer=1;		// звуковой сигнал откл
	       
	       TMOD=0x01;  	//16-битный режим для таймера 0
	       TH0=0xFF;   	// Загружаем старший байт в регистрTH
	       TL0=0x06;   	// Загружаем младший байт в регистр TL
	       TR0=1;      	// Запускаем таймер
	       while(!TF0);   	// пока таймер не переполнен выполняем пустой цикл
	       TR0 = 0;      	// При переполнении останавливаем таймер
	       TF0 = 0;      	// очищаем флаг переполнения для следующего цикла
	       count++;
	       }
      S++;
      lcdcmd(0xCB);
      tochar(S);
      count=0;
      while(count!=490)
	    {
	       TMOD=0x01;  	//16-битный режим для таймера 0
	       TH0=0xFC;   	// Загружаем старший байт в регистрTH
	       TL0=0x18;   	// Загружаем младший байт в регистр TL
	       TR0=1;      	// Запускаем таймер
	       while(!TF0);   	// пока таймер не переполнен выполняем пустой цикл
	       TR0 = 0;      	// При переполнении останавливаем таймер
	       TF0 = 0;      	// очищаем флаг переполнения для следующего цикла
	       count++;
	       }
      S++;
      lcdcmd(0xCB);
      tochar(S);
   }



/***************************************************************************************************************/
//Функция проверки условий
void chkConditions(){
   unsigned int chk;
    
   chk=chkKey();				//выбор настроек
   switch(chk) 
   {
      case 1:					//переустановка часов
	 setTime();
	 start();
	 break;
      
      case 2:					//установка будильника
	 setAlarm();
	 break;
      }


   
   /*Пересчёт часов и минут*/
   if((H==12) && (M>=59) && (S>=59))
      {
	 S=0; H=1; M=0;
	start();
      } 
  
   
   if(S>59)
      { 
	 S=0;
	 M++;
	 if(M>=60)
	    { 
	       H++;
	       M=0;
	       signal1();
	       signal2();
	    }
	// if(M==30){
	  //  signal1();
	  //  signal2();
	  //  }
	 lcdcmd(0xC4);
	 tochar(H);
	 lcddata(':');
	 tochar(M);
	 lcdcmd(0xCB);
	 tochar(S);
	 lcddata(' ');
      }
}



/***************************************************************************************************************/
//Функция отсчитывающая секунды, минуты, часы
void clockdelay()
{
   int count=0,sec;
   for(sec=0;sec<60;sec++)
      {
	    count=0;
	    while(count!=485)
	    {
	       TMOD=0x01;  	//16-битный режим для таймера 0
	       TH0=0xF8;   	// Загружаем старший байт в регистрTH
	       TL0=0x30;   	// Загружаем младший байт в регистр TL
	       TR0=1;      	// Запускаем таймер
	       while(!TF0);   	// пока таймер не переполнен выполняем пустой цикл
	       TR0 = 0;      	// При переполнении останавливаем таймер
	       TF0 = 0;      	// очищаем флаг переполнения для следующего цикла
	       count++;
	       }
	    S++;
	    lcdcmd(0xCB);
	    tochar(S);
	    chkConditions();
	    if(H==H1) 		// срабатывание установленного будильника
	       {
		  if(M==M1){
		     signal1();
		     signal2();
		  }
	       }
	      
      }
}


/***************************************************************************************************************/
// Функция отображения установленного времени
void start()
{
   count=0;
   lcdcmd(0x01);
   lcdcmd(0x80);
   
   
   if(flag==1) 			// если будильник установлен
	    {   
	       while(alarm[count]!='\0')
		  {
		     lcddata(alarm[count]);
		     count++;
		  }
	    }
	 else 
	    {
	       //вывод подсказки о переустановке
	       while(hint[count]!='\0'){
			lcddata(hint[count]);
			count++;
		    }
		    
	       count=0;
	       lcdcmd(0x89); 	//установка курсора на первую строку правее

	       //вывод подсказки
	       while(clock[count]!='\0'){
		    lcddata(clock[count]);
		    count++;
		  }
	     }
	     
   count=0;
   lcdcmd(0xC4);	//установка курсора на вторую строку
   tochar(H);		//вывод значения часов
   lcddata(':');
   tochar(M);		//вывод значения минут
   lcdcmd(0xCB);	//курсор на второй строке сдвинуть правее
   tochar(S);		//вывод значения секунд
}


/***************************************************************************************************************/
// Установка времени
void setTime()
{
	lcdcmd(0x01); 	// 0000 0001 - очистить дисплей
	lcdcmd(0x80); 	// 1000 0000 - установка адреса DDRAM - перенос курсора на 1-ю строку 1-й столбец
   
	//вывод подсказки, установка количества часов
	while(hour[count]!='\0'){
	    lcddata(hour[count]);
	    count++;
	}
	count=0;
	lcdcmd(0xC8); 	// 1100 1000 - установка курсора на вторую строку
	
	// считывание введённого значения для поля "час"
	while(count!=2){
	    hour1[count]=keypad();
	    count++;
	}
	H=(hour1[0]*10)+hour1[1]; 	//преобразуем ввод и сохраняем количество часов 
	count=0;
	lcdcmd(0x01);
	lcdcmd(0x80);
	
	//вывод подсказки, установка количества минут
	while(mint[count]!='\0'){
	    lcddata(mint[count]);
	    count++;
	}
	count=0;
	lcdcmd(0xC8);
	
	// считывание введённого значения для поля "минуты"
	while(count!=2){
	    mint1[count]=keypad();
	    count++;
	}
	M=(mint1[0]*10)+mint1[1];  //преобразуем ввод и сохраняем количество минут
	count=0;
	S=0;
	delay(10000); 	//выдержка 0,1с
	lcdcmd(0x01);
	lcdcmd(0x80);	
}


/***************************************************************************************************************/
//Функция инициализации при включении
void lcdint(void)         
{
      //После подачи питания, до отправки команд
      P0=0x00;  		//порт P0 - порт вывода
      P1=0xFF; 		//порт P1 - порт ввода
      P2=0x00; 	 	//порт P2 - порт вывода               
      P3=0x00; 		// порт P3 - порт вывода
   
   
      //Инициализация HD44780
      delay(15000);  	//задержка 15 миллисекунд
      lcddata(0x30); 	//подать сигнал на входы
      delay(5000); 	//выдержать 5 милисекунд
      lcddata(0x30);
      delay(300);
      lcddata(0x30);
      delay(650);
   
      //Отправка команд на HD44780
      lcdcmd(0x38);  	// 0011 1000 -  режим 8-разрядной шины, 2 строки дисплея, шрифт 5х8
      delay(50);
      lcdcmd(0x0C); 	// 0000 1100 - включить дисплей, курсор и его мигание отключены
      delay(50);
      lcdcmd(0x01); 	// 0000 0001 - очистить дисплей
      delay(50);
      lcdcmd(0x06); 	// 0000 0110 - сдвига дисплея нет,курсор сдвигается на 1 вправо после записи, адрес DDRAM увеличивается
      delay(50);
      lcdcmd(0x80); 	// 1000 0000 - установка адреса DDRAM - перенос курсора на первую строку 1 столбец
      delay(50);
      buzzer=1;		// звуковой сигнал выкл
}

/***************************************************************************************************************/
/***************************************************************************************************************/
/***************************************************************************************************************/
//Основная программа
void main()
{
   lcdint();
   setTime();
   start();
   while(1){
      clockdelay();
      }
}
